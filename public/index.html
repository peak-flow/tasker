<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tasker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: '#0f1117',
            surface: '#1a1d27',
            surface2: '#232733',
            border: '#2d3140',
            txt: '#e1e4ed',
            muted: '#8b90a0',
            accent: '#6c8cff',
            'accent-dim': '#3d5199',
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'system-ui', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #2d3140; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #3d5199; }

    /* Smooth transitions */
    .task-row { transition: background-color 0.15s ease; }

    /* Spinner animation */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 0.8s linear infinite; }

    /* Input focus reset */
    input:focus, textarea:focus { outline: none; }
  </style>
</head>
<body class="bg-bg text-txt font-sans min-h-screen" x-data="app()" x-cloak>

  <!-- Main Layout -->
  <div class="flex min-h-screen">

    <!-- ==================== SIDEBAR ==================== -->
    <aside class="w-64 flex-shrink-0 bg-surface border-r border-border flex flex-col">

      <!-- Logo -->
      <div class="px-4 py-4 border-b border-border">
        <h1 class="text-lg font-semibold text-txt flex items-center gap-2">
          <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
          </svg>
          Tasker
        </h1>
      </div>

      <!-- Project List -->
      <div class="flex-1 overflow-y-auto py-2">
        <div class="px-3 mb-2">
          <span class="text-[11px] uppercase tracking-wider text-muted font-medium">Projects</span>
        </div>

        <template x-for="project in projects" :key="project.id">
          <div
            class="group flex items-center gap-2 px-3 py-2 mx-2 rounded-md cursor-pointer transition-colors"
            :class="selectedProjectId === project.id ? 'bg-accent/15 text-accent' : 'hover:bg-surface2 text-txt'"
            @click="selectProject(project.id)"
          >
            <!-- Color dot -->
            <span class="w-2.5 h-2.5 rounded-full flex-shrink-0"
              :style="'background-color:' + (project.color || '#6c8cff')"></span>

            <!-- Inline edit mode -->
            <template x-if="editingProjectId === project.id">
              <input type="text"
                class="flex-1 bg-surface2 text-txt text-sm px-2 py-0.5 rounded border border-border focus:border-accent min-w-0"
                :value="project.name"
                @keydown.enter="$el.dataset.saved = '1'; updateProject(project.id, { name: $el.value }); editingProjectId = null"
                @keydown.escape="editingProjectId = null"
                @click.stop
                @blur="if (!$el.dataset.saved && $el.value.trim() && $el.value !== project.name) { updateProject(project.id, { name: $el.value }); } editingProjectId = null"
                x-init="$nextTick(() => { $el.focus(); $el.select(); })">
            </template>

            <!-- Display mode -->
            <template x-if="editingProjectId !== project.id">
              <span class="flex-1 text-sm truncate" @dblclick.stop="editingProjectId = project.id" x-text="project.name"></span>
            </template>

            <!-- Hover actions -->
            <template x-if="editingProjectId !== project.id">
              <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="p-1 rounded hover:bg-surface2 text-muted hover:text-txt" @click.stop="editingProjectId = project.id" title="Edit name">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                </button>
                <button class="p-1 rounded hover:bg-red-500/20 text-muted hover:text-red-400" @click.stop="deleteProject(project.id)" title="Delete project">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </template>
          </div>
        </template>

        <!-- Empty state -->
        <template x-if="projects.length === 0">
          <div class="px-4 py-8 text-center">
            <p class="text-muted text-sm">No projects yet.</p>
            <p class="text-muted text-xs mt-1">Create one below to get started.</p>
          </div>
        </template>
      </div>

      <!-- Add project + Settings -->
      <div class="px-3 py-3 border-t border-border">
        <form @submit.prevent="createProject()" class="flex items-center gap-2">
          <input type="text" x-model="newProjectName" placeholder="New project..."
            class="flex-1 bg-surface2 text-txt text-sm px-3 py-1.5 rounded-md border border-border focus:border-accent placeholder-muted/50">
          <button type="submit" :disabled="!newProjectName.trim()"
            class="px-2.5 py-1.5 bg-accent text-white text-sm rounded-md hover:bg-accent/80 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          </button>
        </form>
        <button @click="openSettings()" class="mt-2 w-full flex items-center gap-2 px-3 py-1.5 text-xs text-muted hover:text-txt hover:bg-surface2 rounded-md transition-colors" title="AI Settings">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          AI Settings
        </button>
      </div>
    </aside>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="flex-1 flex flex-col overflow-hidden">

      <!-- Header -->
      <div class="px-6 py-4 border-b border-border bg-surface flex items-center justify-between">
        <template x-if="selectedProject">
          <div class="flex items-center gap-3">
            <span class="w-3 h-3 rounded-full" :style="'background-color:' + (selectedProject.color || '#6c8cff')"></span>
            <h2 class="text-lg font-medium text-txt" x-text="selectedProject.name"></h2>
            <span class="text-xs text-muted bg-surface2 px-2 py-0.5 rounded-full" x-text="taskCount + ' tasks'"></span>
          </div>
        </template>
        <template x-if="!selectedProject">
          <div><h2 class="text-lg font-medium text-muted">Select a project</h2></div>
        </template>
        <div class="flex items-center gap-1.5">
          <button @click="exportData()" class="px-2.5 py-1.5 text-xs text-muted hover:text-txt hover:bg-surface2 rounded-md transition-colors flex items-center gap-1.5" title="Export all data">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            Export
          </button>
          <label class="px-2.5 py-1.5 text-xs text-muted hover:text-txt hover:bg-surface2 rounded-md transition-colors flex items-center gap-1.5 cursor-pointer" title="Import data">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
            Import
            <input type="file" accept=".json" @change="importData($event)" class="hidden">
          </label>
        </div>
      </div>

      <!-- Task Tree Area -->
      <div class="flex-1 overflow-y-auto">

        <!-- Active project with tasks loaded -->
        <template x-if="selectedProjectId && !loadingTasks">
          <div class="px-4 py-3">

            <!-- Unified flat items loop: tasks + add-child rows interleaved -->
            <template x-for="item in flatItems" :key="item._key">
              <div>

                <!-- === TASK ROW === -->
                <template x-if="item._type === 'task'">
                  <div class="task-row flex items-center gap-1.5 py-1.5 pr-2 rounded-md hover:bg-surface2/50 group relative"
                    :class="blockerCounts[item.id] ? 'border-l-2 border-l-red-500/70' : ''"
                    :style="'padding-left:' + (item.depth * 24 + 8) + 'px'">

                    <!-- Connector line -->
                    <template x-if="item.depth > 0">
                      <div class="absolute top-0 bottom-0 border-l border-border"
                        :style="'left:' + ((item.depth - 1) * 24 + 20) + 'px'"></div>
                    </template>

                    <!-- Chevron expand/collapse -->
                    <button class="w-5 h-5 flex items-center justify-center rounded hover:bg-surface2 flex-shrink-0"
                      :class="item._hasChildren ? 'text-muted hover:text-txt cursor-pointer' : 'text-transparent cursor-default'"
                      @click="item._hasChildren && toggleExpand(item)">
                      <svg class="w-3.5 h-3.5 transition-transform duration-150" :class="item.is_expanded ? 'rotate-90' : ''"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </button>

                    <!-- Color dot -->
                    <span class="w-2 h-2 rounded-full flex-shrink-0" :style="'background-color:' + getColor(item.depth)"></span>

                    <!-- Inline edit -->
                    <template x-if="editingTaskId === item.id">
                      <input type="text"
                        class="flex-1 bg-surface2 text-txt text-sm px-2 py-0.5 rounded border border-border focus:border-accent min-w-0"
                        :value="item.label"
                        @keydown.enter="$el.dataset.saved = '1'; updateTask(item.id, { label: $el.value }); editingTaskId = null"
                        @keydown.escape="editingTaskId = null"
                        @click.stop
                        @blur="if (!$el.dataset.saved && $el.value.trim() && $el.value !== item.label) { updateTask(item.id, { label: $el.value }); } editingTaskId = null"
                        x-init="$nextTick(() => { $el.focus(); $el.select(); })">
                    </template>

                    <!-- Display label -->
                    <template x-if="editingTaskId !== item.id">
                      <span class="flex-1 text-sm text-txt truncate cursor-text" @dblclick="editingTaskId = item.id" x-text="item.label"></span>
                    </template>

                    <!-- Descendant count badge -->
                    <template x-if="item._descendantCount > 0">
                      <span class="text-[10px] text-muted bg-surface2 px-1.5 py-0.5 rounded-full flex-shrink-0" x-text="item._descendantCount"></span>
                    </template>

                    <!-- Blocker count badge -->
                    <template x-if="blockerCounts[item.id] > 0">
                      <button class="flex items-center gap-1 text-[10px] text-red-400 bg-red-500/15 px-1.5 py-0.5 rounded-full flex-shrink-0 hover:bg-red-500/25 transition-colors cursor-pointer"
                        @click="openBlockerPanel(item.id)" title="View blockers">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        <span x-text="blockerCounts[item.id]"></span>
                      </button>
                    </template>

                    <!-- AI loading spinner -->
                    <template x-if="loadingTaskId === item.id">
                      <div class="flex-shrink-0">
                        <svg class="w-4 h-4 text-accent spinner" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                      </div>
                    </template>

                    <!-- Action buttons -->
                    <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"
                      x-show="loadingTaskId !== item.id">
                      <!-- Add child -->
                      <button class="p-1 rounded hover:bg-surface2 text-muted hover:text-green-400" @click="startAddChild(item)" title="Add subtask">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                      </button>
                      <!-- Blockers -->
                      <button class="p-1 rounded hover:bg-red-500/20 text-muted hover:text-red-400" @click="openBlockerPanel(item.id)" title="Manage blockers">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                      </button>
                      <!-- AI breakdown -->
                      <button class="p-1 rounded hover:bg-purple-500/20 text-muted hover:text-purple-400" @click="breakdownTask(item)" title="AI breakdown">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                      </button>
                      <!-- Edit -->
                      <button class="p-1 rounded hover:bg-surface2 text-muted hover:text-txt" @click="editingTaskId = item.id" title="Edit label">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                      </button>
                      <!-- Delete -->
                      <button class="p-1 rounded hover:bg-red-500/20 text-muted hover:text-red-400" @click="deleteTask(item.id)" title="Delete task">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                      </button>
                    </div>
                  </div>
                </template>

                <!-- === ADD CHILD ROW === -->
                <template x-if="item._type === 'add-child'">
                  <div :style="'padding-left:' + (item.depth * 24 + 8) + 'px'" class="py-1">
                    <form @submit.prevent="submitChild(item._parentId)" class="flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full flex-shrink-0" :style="'background-color:' + getColor(item.depth)"></span>
                      <input type="text" x-model="newChildLabel" placeholder="New subtask..."
                        class="flex-1 bg-surface2 text-txt text-sm px-2 py-1 rounded border border-border focus:border-accent placeholder-muted/50"
                        @keydown.escape="addingChildToId = null; newChildLabel = ''"
                        x-init="$nextTick(() => $el.focus())">
                      <button type="submit" :disabled="!newChildLabel.trim()" class="text-xs text-accent hover:text-accent/80 disabled:opacity-30">Add</button>
                      <button type="button" @click="addingChildToId = null; newChildLabel = ''" class="text-xs text-muted hover:text-txt">Cancel</button>
                    </form>
                  </div>
                </template>

              </div>
            </template>

            <!-- Empty task state -->
            <template x-if="tasks.length === 0">
              <div class="py-16 text-center">
                <svg class="w-12 h-12 text-muted/30 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <p class="text-muted text-sm">No tasks yet.</p>
                <p class="text-muted/60 text-xs mt-1">Add your first task below.</p>
              </div>
            </template>

            <!-- Add root task -->
            <div class="mt-3 px-2">
              <form @submit.prevent="createTask(newTaskLabel)" class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full flex-shrink-0 bg-accent"></span>
                <input type="text" x-model="newTaskLabel" placeholder="Add a task..."
                  class="flex-1 bg-surface2/50 text-txt text-sm px-3 py-1.5 rounded-md border border-border/50 focus:border-accent focus:bg-surface2 placeholder-muted/40 transition-colors">
                <button type="submit" :disabled="!newTaskLabel.trim()"
                  class="px-3 py-1.5 text-xs font-medium text-accent hover:bg-accent/10 rounded-md disabled:opacity-30 disabled:cursor-not-allowed transition-colors">Add</button>
              </form>
            </div>
          </div>
        </template>

        <!-- Loading state -->
        <template x-if="loadingTasks">
          <div class="flex items-center justify-center py-16">
            <svg class="w-6 h-6 text-accent spinner" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-2 text-sm text-muted">Loading tasks...</span>
          </div>
        </template>

        <!-- No project selected -->
        <template x-if="!selectedProjectId">
          <div class="flex flex-col items-center justify-center py-24">
            <svg class="w-16 h-16 text-muted/20 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
            <p class="text-muted text-base">Select a project to view tasks</p>
            <p class="text-muted/50 text-sm mt-1">Or create a new project in the sidebar</p>
          </div>
        </template>
      </div>
    </main>
  </div>

  <!-- Toast notification -->
  <div x-show="toast.show"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-2"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-2"
    class="fixed bottom-4 right-4 px-4 py-2.5 rounded-lg shadow-lg text-sm z-50"
    :class="toast.type === 'error' ? 'bg-red-500/90 text-white' : 'bg-accent/90 text-white'"
    x-text="toast.message">
  </div>

  <!-- ==================== BLOCKER PANEL MODAL ==================== -->
  <div x-show="showBlockerPanel" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @keydown.escape.window="closeBlockerPanel()">

    <div class="bg-surface rounded-lg border border-border shadow-2xl w-[520px] max-h-[80vh] flex flex-col"
      @click.outside="closeBlockerPanel()">

      <!-- Modal header -->
      <div class="px-5 py-4 border-b border-border flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
          <h3 class="text-sm font-medium text-txt">Blockers for: <span class="text-accent" x-text="getTaskLabel(blockerTaskId)"></span></h3>
        </div>
        <button @click="closeBlockerPanel()" class="p-1 rounded hover:bg-surface2 text-muted hover:text-txt transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Modal body (scrollable) -->
      <div class="flex-1 overflow-y-auto px-5 py-4 space-y-4">

        <!-- Current blockers list -->
        <div>
          <h4 class="text-xs uppercase tracking-wider text-muted font-medium mb-2">Current Blockers</h4>

          <!-- No blockers -->
          <template x-if="blockers.length === 0">
            <div class="text-sm text-muted/60 py-3 text-center border border-dashed border-border rounded-md">
              No blockers assigned
            </div>
          </template>

          <!-- Blocker items -->
          <template x-for="b in blockers" :key="b.id">
            <div class="flex items-center gap-3 py-2 px-3 rounded-md bg-surface2/50 border border-border/50 mb-1.5 group/blocker">
              <svg class="w-3.5 h-3.5 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
              </svg>
              <div class="flex-1 min-w-0">
                <span class="text-sm text-txt block truncate" x-text="b.blocker_label"></span>
                <template x-if="b.note">
                  <span class="text-xs text-muted block truncate mt-0.5" x-text="b.note"></span>
                </template>
              </div>
              <button @click="removeBlocker(blockerTaskId, b.blocker_id)"
                class="p-1 rounded hover:bg-red-500/20 text-muted hover:text-red-400 opacity-0 group-hover/blocker:opacity-100 transition-all flex-shrink-0"
                title="Remove blocker">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </template>
        </div>

        <!-- Divider -->
        <div class="border-t border-border"></div>

        <!-- Add blocker section -->
        <div>
          <h4 class="text-xs uppercase tracking-wider text-muted font-medium mb-2">Add Blocker</h4>

          <!-- Search input -->
          <input type="text" x-model="blockerSearch" placeholder="Search tasks to add as blocker..."
            class="w-full bg-surface2 text-txt text-sm px-3 py-2 rounded-md border border-border focus:border-accent placeholder-muted/50 mb-2">

          <!-- Optional note -->
          <template x-if="blockerSearch.trim()">
            <input type="text" x-model="blockerNote" placeholder="Optional note..."
              class="w-full bg-surface2 text-txt text-sm px-3 py-1.5 rounded-md border border-border focus:border-accent placeholder-muted/50 mb-2">
          </template>

          <!-- Search results -->
          <template x-if="blockerSearch.trim()">
            <div class="border border-border rounded-md overflow-hidden">
              <template x-if="blockerSearchResults.length === 0">
                <div class="text-sm text-muted/60 py-3 text-center">No matching tasks found</div>
              </template>
              <template x-for="task in blockerSearchResults" :key="task.id">
                <button @click="addBlocker(blockerTaskId, task.id, blockerNote)"
                  class="w-full flex items-center gap-2 px-3 py-2 text-left hover:bg-surface2 transition-colors border-b border-border/50 last:border-b-0">
                  <svg class="w-3 h-3 text-muted flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                  </svg>
                  <span class="text-sm text-txt truncate" x-text="task.label"></span>
                </button>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Modal footer -->
      <div class="px-5 py-3 border-t border-border flex-shrink-0">
        <button @click="closeBlockerPanel()"
          class="w-full px-4 py-2 text-sm text-muted hover:text-txt hover:bg-surface2 rounded-md transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== SETTINGS MODAL ==================== -->
  <div x-show="showSettings" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/60" @keydown.escape.window="showSettings && closeSettings()">
    <div class="bg-surface rounded-lg border border-border shadow-2xl w-[620px] max-w-[92vw] max-h-[80vh] flex flex-col" @click.outside="closeSettings()">
      <!-- Header -->
      <div class="px-5 py-4 border-b border-border flex items-center justify-between">
        <h3 class="text-sm font-medium text-txt">AI Settings</h3>
        <button @click="closeSettings()" class="p-1 rounded hover:bg-surface2 text-muted hover:text-txt">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <!-- Body: sidebar + content -->
      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar Nav -->
        <div class="w-[140px] border-r border-border p-2 flex-shrink-0">
          <button @click="settingsTab = 'model'" class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-xs transition-colors mb-1"
            :class="settingsTab === 'model' ? 'bg-accent/12 text-accent' : 'text-muted hover:text-txt hover:bg-surface2'">
            <span class="text-sm">&#9881;</span> Model
          </button>
          <button @click="settingsTab = 'pricing'" class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-xs transition-colors mb-1"
            :class="settingsTab === 'pricing' ? 'bg-accent/12 text-accent' : 'text-muted hover:text-txt hover:bg-surface2'">
            <span class="text-sm">$</span> Pricing
          </button>
          <button @click="settingsTab = 'logs'; fetchAiLogs()" class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-xs transition-colors"
            :class="settingsTab === 'logs' ? 'bg-accent/12 text-accent' : 'text-muted hover:text-txt hover:bg-surface2'">
            <span class="text-sm">&#9776;</span> Logs
          </button>
        </div>
        <!-- Content -->
        <div class="flex-1 overflow-y-auto px-5 py-4 space-y-4">

          <!-- ========== MODEL TAB ========== -->
          <template x-if="settingsTab === 'model'">
            <div class="space-y-4">
              <!-- Provider Cards -->
              <div>
                <label class="text-xs uppercase tracking-wider text-muted font-medium block mb-2">Provider</label>
                <div class="flex flex-col gap-2">
                  <template x-for="prov in providerList" :key="prov.key">
                    <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer transition-all border"
                      :class="settingsForm.ai_provider === prov.key
                        ? 'border-accent bg-accent/10'
                        : 'border-border bg-surface2/50 hover:border-accent/40'"
                      @click="settingsForm.ai_provider = prov.key; onProviderChange()">
                      <span class="w-8 h-8 rounded-lg flex items-center justify-center text-sm flex-shrink-0"
                        :style="'background:' + prov.color + '20;color:' + prov.color" x-text="prov.icon"></span>
                      <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-txt" x-text="prov.name"></div>
                        <div class="text-[11px] text-muted truncate" x-text="prov.desc"></div>
                      </div>
                      <span class="text-[10px] px-2 py-0.5 rounded-full flex-shrink-0"
                        :class="isProviderConfigured(prov.key)
                          ? 'bg-green-500/15 text-green-400'
                          : 'bg-surface2 text-muted/60'"
                        x-text="isProviderConfigured(prov.key) ? 'Ready' : 'Not set up'"></span>
                    </div>
                  </template>
                </div>
              </div>

              <div class="border-t border-border"></div>

              <!-- API Key -->
              <div>
                <label class="text-xs uppercase tracking-wider text-muted font-medium block mb-1.5">API Key</label>
                <div class="flex gap-2">
                  <input type="password" x-model="settingsForm.ai_api_key"
                    placeholder="Enter API key"
                    class="flex-1 bg-surface2 text-txt text-sm px-3 py-2 rounded-md border border-border focus:border-accent focus:outline-none placeholder-muted/40">
                  <button @click="fetchModels()" :disabled="fetchingModels || !settingsForm.ai_api_key.trim()"
                    class="px-3 py-2 text-xs bg-surface2 text-muted hover:text-txt border border-border rounded-md hover:border-accent disabled:opacity-30 disabled:cursor-not-allowed transition-colors whitespace-nowrap">
                    <span x-show="!fetchingModels">Fetch Models</span>
                    <span x-show="fetchingModels">Loading...</span>
                  </button>
                </div>
                <div class="flex items-center gap-1.5 mt-1.5">
                  <span class="w-1.5 h-1.5 rounded-full flex-shrink-0"
                    :class="isProviderConfigured(settingsForm.ai_provider) ? 'bg-green-400' : 'bg-red-400'"></span>
                  <span class="text-[11px]"
                    :class="isProviderConfigured(settingsForm.ai_provider) ? 'text-green-400/70' : 'text-red-400/70'"
                    x-text="isProviderConfigured(settingsForm.ai_provider) ? 'API key saved in browser' : 'No API key set'"></span>
                </div>
              </div>

              <!-- Base URL -->
              <div>
                <label class="text-xs uppercase tracking-wider text-muted font-medium block mb-1.5">API Base URL <span class="normal-case text-muted/60">(optional, for custom endpoints)</span></label>
                <input type="text" x-model="settingsForm.ai_base_url"
                  :placeholder="settingsForm.ai_provider === 'openai' ? 'https://api.openai.com/v1' : settingsForm.ai_provider === 'anthropic' ? 'https://api.anthropic.com' : 'https://generativelanguage.googleapis.com/v1beta'"
                  class="w-full bg-surface2 text-txt text-sm px-3 py-2 rounded-md border border-border focus:border-accent focus:outline-none placeholder-muted/40">
                <p class="text-xs text-muted/60 mt-1">Leave blank for default. Use custom URL for LM Studio, Ollama, etc.</p>
              </div>

              <!-- Model -->
              <div>
                <label class="text-xs uppercase tracking-wider text-muted font-medium block mb-1.5">Model</label>
                <template x-if="availableModels.length > 0">
                  <div>
                    <select x-model="settingsForm.ai_model" class="w-full bg-surface2 text-txt text-sm px-3 py-2 rounded-md border border-border focus:border-accent focus:outline-none">
                      <option value="">Use default</option>
                      <template x-for="m in availableModels" :key="m">
                        <option :value="m" x-text="m"></option>
                      </template>
                    </select>
                  </div>
                </template>
                <template x-if="availableModels.length === 0">
                  <input type="text" x-model="settingsForm.ai_model" placeholder="Leave blank for default"
                    class="w-full bg-surface2 text-txt text-sm px-3 py-2 rounded-md border border-border focus:border-accent focus:outline-none placeholder-muted/40">
                </template>
                <p class="text-xs text-muted/60 mt-1">
                  <span x-show="settingsForm.ai_provider === 'gemini'">Default: gemini-2.0-flash</span>
                  <span x-show="settingsForm.ai_provider === 'openai'">Default: gpt-4o-mini</span>
                  <span x-show="settingsForm.ai_provider === 'anthropic'">Default: claude-sonnet-4-20250514</span>
                  <span x-show="availableModels.length > 0" class="ml-1 text-green-400/70">(<span x-text="availableModels.length"></span> models found)</span>
                </p>
                <!-- Inline pricing for selected model -->
                <template x-if="getModelPrice(settingsForm.ai_model || getDefaultModel(settingsForm.ai_provider))">
                  <p class="text-xs mt-1.5">
                    <span class="text-amber-400/80" x-text="'$' + getModelPrice(settingsForm.ai_model || getDefaultModel(settingsForm.ai_provider)).input + '/1M input'"></span>
                    <span class="text-muted/40 mx-1">&middot;</span>
                    <span class="text-amber-400/80" x-text="'$' + getModelPrice(settingsForm.ai_model || getDefaultModel(settingsForm.ai_provider)).output + '/1M output'"></span>
                  </p>
                </template>
                <template x-if="(settingsForm.ai_model || getDefaultModel(settingsForm.ai_provider)) && !getModelPrice(settingsForm.ai_model || getDefaultModel(settingsForm.ai_provider))">
                  <p class="text-[11px] text-muted/40 mt-1.5">Pricing unavailable for this model</p>
                </template>
              </div>
            </div>
          </template>

          <!-- ========== PRICING TAB ========== -->
          <template x-if="settingsTab === 'pricing'">
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <label class="text-xs uppercase tracking-wider text-muted font-medium">Pricing &mdash; <span class="normal-case" x-text="providerList.find(p => p.key === settingsForm.ai_provider)?.name || settingsForm.ai_provider"></span></label>
                <button @click="refreshPricing()" :disabled="refreshingPricing" class="text-[10px] text-muted/60 hover:text-accent transition-colors disabled:opacity-30 flex items-center gap-1">
                  <span x-show="!refreshingPricing">↻ Refresh from official pages</span>
                  <span x-show="refreshingPricing">Fetching pricing pages...</span>
                </button>
              </div>
              <div class="rounded-lg border border-border overflow-hidden">
                <table class="w-full text-[11px]">
                  <thead>
                    <tr class="bg-surface2/80 text-muted">
                      <th class="text-left px-2.5 py-1.5 font-medium">Model</th>
                      <th class="text-right px-2.5 py-1.5 font-medium">Input / 1M tokens</th>
                      <th class="text-right px-2.5 py-1.5 font-medium">Output / 1M tokens</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="row in getProviderPricing(settingsForm.ai_provider)" :key="row.model">
                      <tr class="border-t border-border/50 hover:bg-surface2/30">
                        <td class="px-2.5 py-1.5 text-txt font-mono text-[11px]" x-text="row.model"></td>
                        <td class="text-right px-2.5 py-1.5 text-amber-400/80" x-text="'$' + row.input"></td>
                        <td class="text-right px-2.5 py-1.5 text-amber-400/80" x-text="'$' + row.output"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
                <div class="px-2.5 py-1.5 bg-surface2/40 text-[10px] text-muted/50 border-t border-border/50">
                  Prices per 1M tokens. <span x-text="pricingLastUpdated ? 'Updated: ' + pricingLastUpdated : 'Default pricing data'"></span>
                </div>
              </div>
              <p class="text-[11px] text-muted/50">Switch provider on the Model tab to see other providers' pricing.</p>
            </div>
          </template>

          <!-- ========== LOGS TAB ========== -->
          <template x-if="settingsTab === 'logs'">
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" :checked="aiLogging" @change="toggleAiLogging()"
                    class="w-3.5 h-3.5 rounded border-border bg-surface2 accent-accent">
                  <span class="text-xs text-muted">Log AI calls</span>
                </label>
                <div class="flex items-center gap-3">
                  <button @click="fetchAiLogs()" class="text-[10px] text-muted/60 hover:text-accent transition-colors">Refresh</button>
                  <button @click="clearAiLogs()" class="text-[10px] text-red-400/60 hover:text-red-400 transition-colors">Clear all</button>
                </div>
              </div>
              <div x-show="aiLogs.length === 0" class="text-center py-8">
                <p class="text-sm text-muted/50">No log entries</p>
                <p class="text-[11px] text-muted/30 mt-1" x-show="!aiLogging">Enable logging above to start recording AI calls</p>
              </div>
              <div x-show="aiLogs.length > 0" class="rounded-lg border border-border overflow-hidden max-h-[340px] overflow-y-auto">
                <template x-for="log in aiLogs" :key="log.id">
                  <div class="px-3 py-2.5 border-b border-border/50 text-[11px]">
                    <div class="flex items-center justify-between text-muted/60 mb-1.5">
                      <span x-text="log.provider + ' · ' + (log.model || 'default') + ' · ' + log.endpoint"></span>
                      <span :class="log.error ? 'text-red-400' : 'text-muted/50'" x-text="log.error ? 'ERR' : log.duration_ms + 'ms'"></span>
                    </div>
                    <details>
                      <summary class="text-muted hover:text-txt cursor-pointer">Prompt <span class="text-muted/40" x-text="'(' + log.prompt.length + ' chars)'"></span></summary>
                      <pre class="mt-1 p-2 bg-surface2/50 rounded text-[10px] text-txt/80 whitespace-pre-wrap max-h-32 overflow-y-auto" x-text="log.prompt"></pre>
                    </details>
                    <details class="mt-1" x-show="log.response">
                      <summary class="text-green-400/70 hover:text-green-400 cursor-pointer">Response <span class="text-muted/40" x-text="'(' + (log.response || '').length + ' chars)'"></span></summary>
                      <pre class="mt-1 p-2 bg-surface2/50 rounded text-[10px] text-txt/80 whitespace-pre-wrap max-h-32 overflow-y-auto" x-text="log.response"></pre>
                    </details>
                    <div x-show="log.error" class="mt-1 text-red-400/80 text-[10px]" x-text="log.error"></div>
                  </div>
                </template>
              </div>
            </div>
          </template>

        </div>
      </div>
      <!-- Footer -->
      <div class="px-5 py-3 border-t border-border flex justify-end gap-2">
        <button @click="closeSettings()" class="px-4 py-2 text-sm text-muted hover:text-txt hover:bg-surface2 rounded-md transition-colors">Cancel</button>
        <button @click="saveSettings()" :disabled="settingsSaving"
          class="px-4 py-2 text-sm bg-accent text-white rounded-md hover:bg-accent/80 disabled:opacity-50 transition-colors">
          <span x-show="!settingsSaving">Save</span>
          <span x-show="settingsSaving">Saving...</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    function app() {
      return {
        // ---- State ----
        projects: [],
        selectedProjectId: null,
        tasks: [],
        newProjectName: '',
        newTaskLabel: '',
        newChildLabel: '',
        editingProjectId: null,
        editingTaskId: null,
        loadingTaskId: null,
        loadingTasks: false,
        addingChildToId: null,
        toast: { show: false, message: '', type: 'info' },

        // Settings state
        showSettings: false,
        settingsTab: 'model',
        settingsForm: { ai_provider: 'gemini', ai_base_url: '', ai_model: '', ai_api_key: '' },
        settingsSaving: false,
        availableModels: [],
        fetchingModels: false,
        _keyRevision: 0,
        showPricingTable: false,
        refreshingPricing: false,
        aiLogging: localStorage.getItem('tasker_ai_logging') === 'true',
        aiLogs: [],
        showAiLogs: false,
        pricingLastUpdated: null,
        modelPricing: {},
        _defaultPricing: {
          'gemini-2.0-flash': { provider: 'gemini', input: '0.10', output: '0.40' },
          'gemini-2.5-flash': { provider: 'gemini', input: '0.30', output: '2.50' },
          'gemini-2.5-flash-lite': { provider: 'gemini', input: '0.10', output: '0.40' },
          'gemini-2.5-pro': { provider: 'gemini', input: '1.25', output: '10.00' },
          'gemini-3-pro': { provider: 'gemini', input: '2.00', output: '12.00' },
          'gemini-3-flash': { provider: 'gemini', input: '0.50', output: '3.00' },
          'gpt-4o': { provider: 'openai', input: '2.50', output: '10.00' },
          'gpt-4o-mini': { provider: 'openai', input: '0.15', output: '0.60' },
          'gpt-4.1': { provider: 'openai', input: '2.00', output: '8.00' },
          'gpt-4.1-mini': { provider: 'openai', input: '0.40', output: '1.60' },
          'gpt-4.1-nano': { provider: 'openai', input: '0.10', output: '0.40' },
          'o3': { provider: 'openai', input: '2.00', output: '8.00' },
          'o3-mini': { provider: 'openai', input: '1.10', output: '4.40' },
          'o4-mini': { provider: 'openai', input: '1.10', output: '4.40' },
          'gpt-5-mini': { provider: 'openai', input: '0.15', output: '0.60' },
          'claude-opus-4-6': { provider: 'anthropic', input: '5.00', output: '25.00' },
          'claude-sonnet-4-6': { provider: 'anthropic', input: '3.00', output: '15.00' },
          'claude-haiku-4-5': { provider: 'anthropic', input: '1.00', output: '5.00' },
          'claude-sonnet-4-0': { provider: 'anthropic', input: '3.00', output: '15.00' },
          'claude-opus-4-0': { provider: 'anthropic', input: '15.00', output: '75.00' },
        },
        providerList: [
          { key: 'gemini', name: 'Google Gemini', desc: 'Fast, free tier available', icon: '\u2726', color: '#4285f4' },
          { key: 'openai', name: 'OpenAI', desc: 'GPT-4o, compatible with LM Studio/Ollama', icon: '\u25CE', color: '#10a37f' },
          { key: 'anthropic', name: 'Anthropic Claude', desc: 'Claude Sonnet/Opus', icon: '\u25C8', color: '#d97706' },
        ],

        // Blocker state
        blockerTaskId: null,
        blockers: [],
        blockerCounts: {},
        showBlockerPanel: false,
        blockerSearch: '',
        blockerNote: '',

        // ---- Computed ----
        get selectedProject() {
          return this.projects.find(p => p.id === this.selectedProjectId) || null;
        },

        // Total task count (all tasks in tree, not just visible)
        get taskCount() {
          const count = (tasks) => {
            let n = 0;
            for (const t of tasks) {
              n += 1;
              if (t.children) n += count(t.children);
            }
            return n;
          };
          return count(this.tasks);
        },

        // Flatten tree into interleaved list of task rows + add-child rows
        get flatItems() {
          const items = [];
          const walk = (tasks, depth, visible = true) => {
            for (const task of tasks) {
              if (!visible) continue;
              const descendantCount = this._countDesc(task);
              const hasChildren = !!(task.children && task.children.length > 0);
              items.push({
                _type: 'task',
                _key: task.id,
                _hasChildren: hasChildren,
                _descendantCount: descendantCount,
                ...task,
                depth,
              });
              // If this task is expanded and has children, render them
              if (hasChildren && task.is_expanded) {
                walk(task.children, depth + 1, true);
              }
              // If we are adding a child to this task, inject the add-child row
              if (this.addingChildToId === task.id) {
                items.push({
                  _type: 'add-child',
                  _key: 'add-' + task.id,
                  _parentId: task.id,
                  depth: depth + 1,
                });
              }
            }
          };
          walk(this.tasks, 0, true);
          return items;
        },

        // ---- Lifecycle ----
        async init() {
          this._loadPricing();
          await this.fetchProjects();
        },

        // ---- Helpers ----
        getDefaultModel(provider) {
          const defaults = { gemini: 'gemini-2.0-flash', openai: 'gpt-4o-mini', anthropic: 'claude-sonnet-4-6' };
          return defaults[provider] || '';
        },

        getModelPrice(modelId) {
          if (!modelId) return null;
          const pricing = this.modelPricing;
          // Direct match
          if (pricing[modelId]) return pricing[modelId];
          // Strip date suffix (e.g. claude-sonnet-4-6-20250514 → claude-sonnet-4-6)
          const stripped = modelId.replace(/-\d{8}$/, '');
          if (pricing[stripped]) return pricing[stripped];
          // Partial match: find key that starts with modelId or vice versa
          for (const key of Object.keys(pricing)) {
            if (modelId.startsWith(key) || key.startsWith(modelId)) return pricing[key];
          }
          return null;
        },

        getProviderPricing(provider) {
          return Object.entries(this.modelPricing)
            .filter(([, v]) => v.provider === provider)
            .map(([model, v]) => ({ model, input: v.input, output: v.output }))
            .sort((a, b) => parseFloat(a.input) - parseFloat(b.input));
        },

        _loadPricing() {
          const saved = localStorage.getItem('tasker_model_pricing');
          if (saved) {
            try {
              const parsed = JSON.parse(saved);
              this.modelPricing = parsed.data || this._defaultPricing;
              this.pricingLastUpdated = parsed.updated || null;
              return;
            } catch {}
          }
          this.modelPricing = { ...this._defaultPricing };
        },

        async refreshPricing() {
          // Collect all configured providers
          const configured = [];
          for (const p of ['gemini', 'openai', 'anthropic']) {
            const k = localStorage.getItem('tasker_ai_key_' + p);
            if (k) configured.push({ provider: p, api_key: k });
          }
          if (configured.length === 0) {
            this.showToast('No API key configured — set up a provider first', 'error');
            return;
          }
          // Use cheapest provider (gemini first) as the AI parser
          const aiParsers = configured.sort((a, b) => {
            const order = { gemini: 0, openai: 1, anthropic: 2 };
            return (order[a.provider] ?? 9) - (order[b.provider] ?? 9);
          });
          const aiParser = aiParsers[0];

          this.refreshingPricing = true;
          const allPricing = {};
          let totalModels = 0;
          const enableLogging = localStorage.getItem('tasker_ai_logging') === 'true';
          try {
            for (const { provider, api_key } of configured) {
              try {
                const res = await fetch('/api/ai/pricing/refresh', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    provider, api_key,
                    ai_provider: aiParser.provider,
                    ai_api_key: aiParser.api_key,
                    enable_logging: enableLogging,
                  }),
                });
                if (!res.ok) {
                  const err = await res.json().catch(() => ({}));
                  console.warn(`Pricing refresh failed for ${provider}:`, err.error);
                  continue;
                }
                const data = await res.json();
                if (data.pricing) {
                  Object.assign(allPricing, data.pricing);
                  totalModels += data.models_priced || 0;
                }
              } catch (err) {
                console.warn(`Pricing refresh error for ${provider}:`, err.message);
              }
            }
            if (Object.keys(allPricing).length > 0) {
              this.modelPricing = allPricing;
              const updated = new Date().toLocaleDateString();
              this.pricingLastUpdated = updated;
              localStorage.setItem('tasker_model_pricing', JSON.stringify({ data: allPricing, updated }));
              this.showToast(`Pricing updated: ${totalModels} models from ${configured.length} provider(s)`);
            } else {
              this.showToast('No pricing data extracted', 'error');
            }
          } catch (err) {
            this.showToast(err.message || 'Failed to update pricing', 'error');
          } finally {
            this.refreshingPricing = false;
          }
        },

        toggleAiLogging() {
          this.aiLogging = !this.aiLogging;
          localStorage.setItem('tasker_ai_logging', this.aiLogging ? 'true' : 'false');
        },

        async fetchAiLogs() {
          try {
            const res = await fetch('/api/ai/logs?limit=50');
            if (!res.ok) throw new Error('Failed to fetch logs');
            this.aiLogs = await res.json();
            this.showAiLogs = true;
          } catch (err) {
            this.showToast('Failed to load logs', 'error');
          }
        },

        async clearAiLogs() {
          try {
            await fetch('/api/ai/logs', { method: 'DELETE' });
            this.aiLogs = [];
            this.showToast('Logs cleared');
          } catch (err) {
            this.showToast('Failed to clear logs', 'error');
          }
        },

        isProviderConfigured(providerKey) {
          this._keyRevision; // reactive dependency — forces Alpine to re-evaluate when keys change
          return !!localStorage.getItem('tasker_ai_key_' + providerKey);
        },

        showToast(message, type = 'info') {
          this.toast = { show: true, message, type };
          setTimeout(() => { this.toast.show = false; }, 3000);
        },

        depthColors: ['#6c8cff', '#4ade80', '#fb923c', '#a78bfa', '#f472b6'],
        getColor(depth) { return this.depthColors[depth % 5]; },

        _countDesc(task) {
          let c = 0;
          const walk = (children) => {
            if (!children) return;
            for (const ch of children) { c++; walk(ch.children); }
          };
          walk(task.children);
          return c;
        },

        // Flatten all tasks in the tree into a flat array
        get allTasksFlat() {
          const result = [];
          const walk = (tasks) => {
            for (const t of tasks) {
              result.push({ id: t.id, label: t.label });
              if (t.children && t.children.length > 0) walk(t.children);
            }
          };
          walk(this.tasks);
          return result;
        },

        // Get a task label by ID
        getTaskLabel(taskId) {
          const t = this.allTasksFlat.find(t => t.id === taskId);
          return t ? t.label : 'Unknown task';
        },

        // Filtered search results for blocker task picker
        get blockerSearchResults() {
          if (!this.blockerSearch.trim()) return [];
          const search = this.blockerSearch.toLowerCase();
          const existingBlockerIds = this.blockers.map(b => b.blocker_id);
          return this.allTasksFlat.filter(t =>
            t.id !== this.blockerTaskId &&
            !existingBlockerIds.includes(t.id) &&
            t.label.toLowerCase().includes(search)
          ).slice(0, 10);
        },

        // Build parent chain label for AI context
        _getTaskContext(task) {
          const findPath = (tasks, targetId, path = []) => {
            for (const t of tasks) {
              if (t.id === targetId) return [...path, t.label];
              if (t.children && t.children.length > 0) {
                const r = findPath(t.children, targetId, [...path, t.label]);
                if (r) return r;
              }
            }
            return null;
          };
          const path = findPath(this.tasks, task.id) || [task.label];
          return path.length > 1
            ? path.slice(0, -1).join(' > ')
            : (this.selectedProject ? this.selectedProject.name : '');
        },

        // Find task reference in the live tree (for optimistic updates)
        _findTask(tasks, id) {
          for (const t of tasks) {
            if (t.id === id) return t;
            if (t.children && t.children.length > 0) {
              const f = this._findTask(t.children, id);
              if (f) return f;
            }
          }
          return null;
        },

        // ===========================
        // PROJECT METHODS
        // ===========================
        async fetchProjects() {
          try {
            const res = await fetch('/api/projects');
            if (!res.ok) throw new Error('fetch failed');
            this.projects = await res.json();
          } catch (err) {
            console.error('fetchProjects:', err);
            this.showToast('Failed to load projects', 'error');
          }
        },

        async createProject() {
          const name = this.newProjectName.trim();
          if (!name) return;
          try {
            const res = await fetch('/api/projects', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name }),
            });
            if (!res.ok) throw new Error('create failed');
            const project = await res.json();
            this.projects.unshift(project);
            this.newProjectName = '';
            this.selectProject(project.id);
          } catch (err) {
            console.error('createProject:', err);
            this.showToast('Failed to create project', 'error');
          }
        },

        async updateProject(id, data) {
          try {
            const res = await fetch(`/api/projects/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
            if (!res.ok) throw new Error('update failed');
            const updated = await res.json();
            const idx = this.projects.findIndex(p => p.id === id);
            if (idx !== -1) this.projects[idx] = updated;
          } catch (err) {
            console.error('updateProject:', err);
            this.showToast('Failed to update project', 'error');
          }
        },

        async deleteProject(id) {
          if (!confirm('Delete this project and all its tasks?')) return;
          try {
            const res = await fetch(`/api/projects/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('delete failed');
            this.projects = this.projects.filter(p => p.id !== id);
            if (this.selectedProjectId === id) {
              this.selectedProjectId = null;
              this.tasks = [];
            }
            this.showToast('Project deleted');
          } catch (err) {
            console.error('deleteProject:', err);
            this.showToast('Failed to delete project', 'error');
          }
        },

        async selectProject(id) {
          if (this.selectedProjectId === id) return;
          this.selectedProjectId = id;
          this.editingTaskId = null;
          this.addingChildToId = null;
          this.newTaskLabel = '';
          this.blockerCounts = {};
          this.closeBlockerPanel();
          await this.fetchTasks();
        },

        // ===========================
        // TASK METHODS
        // ===========================
        async fetchTasks() {
          if (!this.selectedProjectId) return;
          this.loadingTasks = true;
          try {
            const res = await fetch(`/api/projects/${this.selectedProjectId}/tasks`);
            if (!res.ok) throw new Error('fetch failed');
            this.tasks = await res.json();
            // Fetch blocker counts for all tasks
            this.$nextTick(() => this.fetchBlockerCounts());
          } catch (err) {
            console.error('fetchTasks:', err);
            this.showToast('Failed to load tasks', 'error');
          } finally {
            this.loadingTasks = false;
          }
        },

        async createTask(label, parentId = null) {
          const trimmed = (label || '').trim();
          if (!trimmed) return;
          try {
            const body = { label: trimmed, project_id: this.selectedProjectId };
            if (parentId) body.parent_id = parentId;
            const res = await fetch('/api/tasks', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            if (!res.ok) throw new Error('create failed');
            // Expand parent if adding child
            if (parentId) {
              const parent = this._findTask(this.tasks, parentId);
              if (parent && !parent.is_expanded) {
                await this._setExpanded(parentId, true);
              }
            }
            this.newTaskLabel = '';
            this.newChildLabel = '';
            await this.fetchTasks();
          } catch (err) {
            console.error('createTask:', err);
            this.showToast('Failed to create task', 'error');
          }
        },

        // Called from the add-child form
        async submitChild(parentId) {
          await this.createTask(this.newChildLabel, parentId);
          this.addingChildToId = null;
        },

        async updateTask(id, data) {
          try {
            const res = await fetch(`/api/tasks/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
            if (!res.ok) throw new Error('update failed');
            if ('is_expanded' in data) {
              const task = this._findTask(this.tasks, id);
              if (task) task.is_expanded = data.is_expanded;
            } else {
              await this.fetchTasks();
            }
          } catch (err) {
            console.error('updateTask:', err);
            this.showToast('Failed to update task', 'error');
          }
        },

        // Helper: just persist is_expanded without full refetch
        async _setExpanded(id, val) {
          try {
            await fetch(`/api/tasks/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ is_expanded: val }),
            });
            const task = this._findTask(this.tasks, id);
            if (task) task.is_expanded = val;
          } catch (e) { /* silent */ }
        },

        async toggleExpand(item) {
          const newState = !item.is_expanded;
          // Optimistic local update
          const task = this._findTask(this.tasks, item.id);
          if (task) task.is_expanded = newState;
          await this._setExpanded(item.id, newState);
        },

        async deleteTask(id) {
          if (!confirm('Delete this task and all its subtasks?')) return;
          try {
            const res = await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('delete failed');
            await this.fetchTasks();
            this.showToast('Task deleted');
          } catch (err) {
            console.error('deleteTask:', err);
            this.showToast('Failed to delete task', 'error');
          }
        },

        startAddChild(item) {
          // Expand if collapsed with children
          if (!item.is_expanded && item._hasChildren) {
            this.toggleExpand(item);
          }
          this.addingChildToId = item.id;
          this.newChildLabel = '';
        },

        async breakdownTask(item) {
          if (this.loadingTaskId) return;
          this.loadingTaskId = item.id;
          try {
            const context = this._getTaskContext(item);
            const res = await fetch('/api/ai/breakdown', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                task_label: item.label,
                context: context || undefined,
                provider: localStorage.getItem('tasker_active_provider') || 'gemini',
                api_key: localStorage.getItem('tasker_ai_key_' + (localStorage.getItem('tasker_active_provider') || 'gemini')) || undefined,
                enable_logging: localStorage.getItem('tasker_ai_logging') === 'true',
              }),
            });
            if (!res.ok) {
              const errData = await res.json().catch(() => ({}));
              throw new Error(errData.error || 'AI breakdown failed');
            }
            const data = await res.json();
            const subtasks = data.subtasks || [];
            if (subtasks.length === 0) {
              this.showToast('AI returned no subtasks', 'error');
              return;
            }
            // Create each subtask
            let created = 0;
            for (const label of subtasks) {
              const r = await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ label, project_id: this.selectedProjectId, parent_id: item.id }),
              });
              if (r.ok) created++;
            }
            // Expand parent and refresh
            await this._setExpanded(item.id, true);
            await this.fetchTasks();
            if (created === subtasks.length) {
              this.showToast(`Added ${created} subtasks`);
            } else if (created > 0) {
              this.showToast(`Added ${created}/${subtasks.length} subtasks (some failed)`, 'error');
            } else {
              this.showToast('Failed to create subtasks', 'error');
            }
          } catch (err) {
            console.error('breakdownTask:', err);
            this.showToast(err.message || 'AI breakdown failed', 'error');
          } finally {
            this.loadingTaskId = null;
          }
        },

        // ===========================
        // BLOCKER METHODS
        // ===========================
        async fetchBlockerCounts() {
          const taskIds = this.allTasksFlat.map(t => t.id);
          if (taskIds.length === 0) return;
          const counts = {};
          await Promise.all(taskIds.map(async (id) => {
            try {
              const res = await fetch(`/api/tasks/${id}/blockers`);
              if (res.ok) {
                const blockers = await res.json();
                if (blockers.length > 0) counts[id] = blockers.length;
              }
            } catch (e) { /* silent */ }
          }));
          this.blockerCounts = counts;
        },

        async openBlockerPanel(taskId) {
          this.blockerTaskId = taskId;
          this.blockers = [];
          this.blockerSearch = '';
          this.blockerNote = '';
          this.showBlockerPanel = true;
          await this.fetchBlockers(taskId);
        },

        async fetchBlockers(taskId) {
          try {
            const res = await fetch(`/api/tasks/${taskId}/blockers`);
            if (!res.ok) throw new Error('fetch blockers failed');
            this.blockers = await res.json();
          } catch (err) {
            console.error('fetchBlockers:', err);
            this.showToast('Failed to load blockers', 'error');
          }
        },

        async addBlocker(taskId, blockerId, note) {
          try {
            const body = { blocker_id: blockerId };
            if (note && note.trim()) body.note = note.trim();
            const res = await fetch(`/api/tasks/${taskId}/blockers`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            if (!res.ok) {
              const errData = await res.json().catch(() => ({}));
              throw new Error(errData.error || 'add blocker failed');
            }
            this.blockerSearch = '';
            this.blockerNote = '';
            await this.fetchBlockers(taskId);
            // Update counts
            this.blockerCounts[taskId] = this.blockers.length;
            this.showToast('Blocker added');
          } catch (err) {
            console.error('addBlocker:', err);
            this.showToast(err.message || 'Failed to add blocker', 'error');
          }
        },

        async removeBlocker(taskId, blockerId) {
          try {
            const res = await fetch(`/api/tasks/${taskId}/blockers/${blockerId}`, {
              method: 'DELETE',
            });
            if (!res.ok) throw new Error('remove blocker failed');
            await this.fetchBlockers(taskId);
            // Update counts
            if (this.blockers.length > 0) {
              this.blockerCounts[taskId] = this.blockers.length;
            } else {
              delete this.blockerCounts[taskId];
              // Trigger reactivity by reassigning
              this.blockerCounts = { ...this.blockerCounts };
            }
            this.showToast('Blocker removed');
          } catch (err) {
            console.error('removeBlocker:', err);
            this.showToast('Failed to remove blocker', 'error');
          }
        },

        closeBlockerPanel() {
          this.showBlockerPanel = false;
          this.blockerTaskId = null;
          this.blockers = [];
          this.blockerSearch = '';
          this.blockerNote = '';
        },

        // ---- Export / Import ----
        async exportData() {
          try {
            const res = await fetch('/api/export');
            if (!res.ok) throw new Error('Export failed');
            const data = await res.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tasker-export-${new Date().toISOString().slice(0, 10)}.json`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            this.showToast(`Exported ${data.projects.length} projects, ${data.tasks.length} tasks`);
          } catch (err) {
            console.error('exportData:', err);
            this.showToast('Failed to export data', 'error');
          }
        },

        async importData(event) {
          const file = event.target.files[0];
          if (!file) return;
          event.target.value = '';

          if (!confirm('This will replace ALL existing projects, tasks, and blockers. Continue?')) return;

          try {
            const text = await file.text();
            const data = JSON.parse(text);

            if (!data.projects || !Array.isArray(data.projects)) {
              throw new Error('Invalid file: missing projects array');
            }

            const res = await fetch('/api/export', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: text,
            });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || 'Import failed');
            }
            const result = await res.json();
            this.showToast(`Imported ${result.imported.projects} projects, ${result.imported.tasks} tasks`);

            // Reload — close blocker panel if open (fix #7)
            this.closeBlockerPanel();
            this.selectedProjectId = null;
            this.tasks = [];
            await this.fetchProjects();
          } catch (err) {
            console.error('importData:', err);
            this.showToast(err.message || 'Failed to import', 'error');
          }
        },

        // ---- Settings ----
        // Provider configs cache (loaded from DB)
        _providerConfigs: {},

        onProviderChange() {
          // Load saved config for the new provider
          const p = this.settingsForm.ai_provider;
          const saved = this._providerConfigs[p] || {};
          this.settingsForm.ai_base_url = saved.base_url || '';
          this.settingsForm.ai_model = saved.model || '';
          this.settingsForm.ai_api_key = localStorage.getItem('tasker_ai_key_' + p) || '';
          this.availableModels = [];
        },

        async fetchModels() {
          const key = this.settingsForm.ai_api_key.trim();
          if (!key) return;
          this.fetchingModels = true;
          this.availableModels = [];
          try {
            const provider = this.settingsForm.ai_provider;
            const baseUrl = this.settingsForm.ai_base_url.trim();
            let models = [];

            if (provider === 'gemini') {
              const url = (baseUrl || 'https://generativelanguage.googleapis.com/v1beta') + '/models?key=' + key;
              const res = await fetch(url);
              if (!res.ok) throw new Error('Failed to fetch models');
              const data = await res.json();
              models = (data.models || [])
                .filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes('generateContent'))
                .map(m => m.name.replace('models/', ''));
            } else if (provider === 'openai') {
              const url = (baseUrl || 'https://api.openai.com/v1') + '/models';
              const headers = key ? { 'Authorization': 'Bearer ' + key } : {};
              const res = await fetch(url, { headers });
              if (!res.ok) throw new Error('Failed to fetch models');
              const data = await res.json();
              models = (data.data || []).map(m => m.id).sort();
            } else if (provider === 'anthropic') {
              const res = await fetch('/api/ai/models', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ provider: 'anthropic', api_key: key, base_url: baseUrl || undefined }),
              });
              if (!res.ok) throw new Error('Failed to fetch models');
              const data = await res.json();
              models = data.models || [];
            }

            this.availableModels = models;
            if (models.length > 0) {
              this.showToast(`Found ${models.length} models`);
            } else {
              this.showToast('No models found', 'error');
            }
          } catch (err) {
            this.showToast(err.message || 'Failed to fetch models', 'error');
          } finally {
            this.fetchingModels = false;
          }
        },

        async openSettings() {
          this.showSettings = true;
          this.settingsTab = 'model';
          this.availableModels = [];
          this._keyRevision++; // force badge re-evaluation from localStorage
          try {
            // Load all provider configs from DB
            const res = await fetch('/api/settings');
            if (!res.ok) throw new Error('fetch failed');
            this._providerConfigs = await res.json();

            // Load active provider from localStorage
            const activeProvider = localStorage.getItem('tasker_active_provider') || 'gemini';
            this.settingsForm.ai_provider = activeProvider;

            // Load that provider's config
            const saved = this._providerConfigs[activeProvider] || {};
            this.settingsForm.ai_base_url = saved.base_url || '';
            this.settingsForm.ai_model = saved.model || '';
            this.settingsForm.ai_api_key = localStorage.getItem('tasker_ai_key_' + activeProvider) || '';
          } catch (err) {
            this.showToast('Failed to load settings', 'error');
          }
        },

        async saveSettings() {
          this.settingsSaving = true;
          try {
            const provider = this.settingsForm.ai_provider;

            // Save this provider's url/model to DB
            const res = await fetch('/api/settings/' + provider, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                base_url: this.settingsForm.ai_base_url || null,
                model: this.settingsForm.ai_model || null,
              }),
            });
            if (!res.ok) throw new Error('save failed');

            // Save active provider + API key to localStorage
            localStorage.setItem('tasker_active_provider', provider);
            if (this.settingsForm.ai_api_key.trim()) {
              localStorage.setItem('tasker_ai_key_' + provider, this.settingsForm.ai_api_key.trim());
            } else {
              localStorage.removeItem('tasker_ai_key_' + provider);
            }

            // Bump reactive tracker so provider badges re-evaluate
            this._keyRevision++;

            // Update local cache
            this._providerConfigs[provider] = {
              base_url: this.settingsForm.ai_base_url || null,
              model: this.settingsForm.ai_model || null,
            };

            this.showToast('Settings saved');
            this.showSettings = false;
          } catch (err) {
            this.showToast('Failed to save settings', 'error');
          } finally {
            this.settingsSaving = false;
          }
        },

        closeSettings() {
          this.showSettings = false;
        },
      };
    }
  </script>
</body>
</html>
